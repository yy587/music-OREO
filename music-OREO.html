<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>增强版照片粒子实时控制 Demo</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#0b0210;color:#fff;font-family:sans-serif;}
#ui{position:absolute;left:12px;top:12px;z-index:10;background:rgba(0,0,0,0.6);padding:12px;border-radius:8px;width:300px;}
#ui label{display:block;margin:6px 0;font-size:14px;}
#ui input[type=range]{width:100%;}
#ui button{margin-top:6px;padding:4px 8px;border:none;border-radius:4px;background:rgba(255,255,255,0.2);color:#fff;cursor:pointer;}
#ui select{width:100%;margin-top:4px;}
</style>
</head>
<body>

<div id="ui">
<label>上传照片：
  <input type="file" id="uploadImages" accept="image/*" multiple>
</label>
<label>当前照片：
  <select id="photoSelect"></select>
</label>
<label>上传音乐：
  <input type="file" id="uploadMusic" accept="audio/*">
</label>
<label>粒子大小：
  <input type="range" id="sizeSlider" min="0.5" max="10" step="0.1" value="2.5">
</label>
<label>低音强度：
  <input type="range" id="lowAmp" min="1" max="200" step="1" value="60">
</label>
<label>中音强度：
  <input type="range" id="midAmp" min="1" max="200" step="1" value="40">
</label>
<label>高音强度：
  <input type="range" id="highAmp" min="1" max="200" step="1" value="30">
</label>
<label>自动旋转速度：
  <input type="range" id="rotateSpeed" min="0" max="0.05" step="0.001" value="0.002">
</label>
<label>散开程度：
  <input type="range" id="scatterSlider" min="0" max="1" step="0.01" value="0">
</label>
<div style="display:flex;gap:6px;margin-top:6px;">
  <button id="playBtn">播放</button>
  <button id="pauseBtn">暂停</button>
  <button id="muteBtn">静音</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script>
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,4000);
camera.position.z = 500;
let renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff,0.7));
let dir = new THREE.DirectionalLight(0xffffff,0.5); dir.position.set(0.5,0.8,1).normalize(); scene.add(dir);

let points=null;
let MAX_PARTICLES=8192;
let basePositions=[], targetPositions=[], colorsArray=[];
let scatteredFactor=0;
let autoRotateSpeed=0.002;

// -------------------- 初始化粒子 --------------------
function initParticles(num=MAX_PARTICLES){
    const positions=new Float32Array(num*3);
    const colors=new Float32Array(num*3);
    basePositions=[]; targetPositions=[]; colorsArray=[];
    for(let i=0;i<num;i++){
        const x=(Math.random()-0.5)*200;
        const y=(Math.random()-0.5)*200;
        const z=(Math.random()-0.5)*200;
        positions[i*3]=x; positions[i*3+1]=y; positions[i*3+2]=z;
        basePositions.push(new THREE.Vector3(x,y,z));
        targetPositions.push(new THREE.Vector3(x,y,z));
        const c=new THREE.Color(Math.random(),Math.random(),Math.random());
        colors[i*3]=c.r; colors[i*3+1]=c.g; colors[i*3+2]=c.b;
        colorsArray.push(c);
    }
    const geom=new THREE.BufferGeometry();
    geom.setAttribute('position',new THREE.BufferAttribute(positions,3));
    geom.setAttribute('color',new THREE.BufferAttribute(colors,3));
    const mat=new THREE.PointsMaterial({size:2.5,vertexColors:true,transparent:true,opacity:0.9});
    points=new THREE.Points(geom,mat);
    scene.add(points);
}
initParticles();

// -------------------- 照片粒子化 --------------------
let photos=[], currentPhotoIndex=0;
const photoSelect=document.getElementById('photoSelect');

document.getElementById('uploadImages').addEventListener('change', e=>{
    const files=Array.from(e.target.files||[]);
    if(!files.length) return;
    photos=[]; let loaded=0;
    files.forEach((f,idx)=>{
        const reader=new FileReader();
        reader.onload=function(ev){
            const img=new Image();
            img.onload=function(){
                photos[idx]=img; loaded++;
                if(loaded===files.length){
                    currentPhotoIndex=0;
                    generateFromImage(photos[0]);
                    photoSelect.innerHTML="";
                    photos.forEach((p,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=`照片${i+1}`; photoSelect.appendChild(opt); });
                }
            }
            img.src=ev.target.result;
        }
        reader.readAsDataURL(f);
    });
});

photoSelect.addEventListener('change',()=>{
    currentPhotoIndex=parseInt(photoSelect.value);
    generateFromImage(photos[currentPhotoIndex]);
});

function generateFromImage(img){
    const maxDim=600;
    const ratio=img.width/img.height;
    let w,h;
    if(ratio>=1){ w=maxDim; h=Math.round(maxDim/ratio);}
    else{ h=maxDim; w=Math.round(maxDim*ratio);}
    const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
    const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
    const data=ctx.getImageData(0,0,w,h).data;

    const posList=[];
    const step = Math.max(1, Math.floor(Math.max(w,h)/Math.sqrt(MAX_PARTICLES)));
    for(let y=0;y<h;y+=step){
        for(let x=0;x<w;x+=step){
            const idx=(y*w+x)*4;
            const r=data[idx], g=data[idx+1], b=data[idx+2], a=data[idx+3];
            if(a<20 || (r+g+b)/3<20) continue;
            const px=(x-w/2); 
            const py=(h/2-y); 
            const pz=(Math.random()-0.5)*20;
            posList.push({pos:new THREE.Vector3(px,py,pz), color:new THREE.Color(r/255,g/255,b/255)});
        }
    }

    const N=Math.min(posList.length,MAX_PARTICLES);
    const positions=new Float32Array(N*3);
    const colors=new Float32Array(N*3);
    basePositions=[]; targetPositions=[]; colorsArray=[];
    for(let i=0;i<N;i++){
        const v=posList[i].pos;
        basePositions.push(v.clone());
        targetPositions.push(v.clone());
        positions[i*3]=v.x; positions[i*3+1]=v.y; positions[i*3+2]=v.z;
        const c=posList[i].color;
        colors[i*3]=c.r; colors[i*3+1]=c.g; colors[i*3+2]=c.b;
        colorsArray.push(c);
    }

    const geom=new THREE.BufferGeometry();
    geom.setAttribute('position',new THREE.BufferAttribute(positions,3));
    geom.setAttribute('color',new THREE.BufferAttribute(colors,3));
    const mat=new THREE.PointsMaterial({size:particleSize,vertexColors:true,transparent:true,opacity:0.9});
    if(points) scene.remove(points);
    points=new THREE.Points(geom,mat); scene.add(points);

    const scaleFactor = 400 / Math.max(w,h);
    points.scale.set(scaleFactor, scaleFactor, scaleFactor);
}

// -------------------- 音乐分析 --------------------
let audioCtx=null, analyser=null, dataArray=null, source=null, audioElem=null;
document.getElementById('uploadMusic').addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return;
    const url=URL.createObjectURL(file);
    if(audioElem) audioElem.pause();
    audioElem=new Audio(url); audioElem.loop=true; audioElem.crossOrigin="anonymous";
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    source=audioCtx.createMediaElementSource(audioElem);
    analyser=audioCtx.createAnalyser(); analyser.fftSize=1024;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser); analyser.connect(audioCtx.destination);
});

// -------------------- 播放/暂停/静音 --------------------
document.getElementById('playBtn').addEventListener('click',()=>{if(audioElem) audioElem.play();});
document.getElementById('pauseBtn').addEventListener('click',()=>{if(audioElem) audioElem.pause();});
document.getElementById('muteBtn').addEventListener('click',()=>{if(audioElem) audioElem.muted=!audioElem.muted;});

// -------------------- UI 控件 --------------------
const sizeSlider=document.getElementById('sizeSlider');
const lowAmpSlider=document.getElementById('lowAmp');
const midAmpSlider=document.getElementById('midAmp');
const highAmpSlider=document.getElementById('highAmp');
const rotateSpeedSlider=document.getElementById('rotateSpeed');
const scatterSlider=document.getElementById('scatterSlider');

let particleSize=parseFloat(sizeSlider.value);
let lowAmp=parseFloat(lowAmpSlider.value);
let midAmp=parseFloat(midAmpSlider.value);
let highAmp=parseFloat(highAmpSlider.value);

sizeSlider.addEventListener('input',()=>{particleSize=parseFloat(sizeSlider.value); if(points) points.material.size=particleSize;});
lowAmpSlider.addEventListener('input',()=>{lowAmp=parseFloat(lowAmpSlider.value);});
midAmpSlider.addEventListener('input',()=>{midAmp=parseFloat(midAmpSlider.value);});
highAmpSlider.addEventListener('input',()=>{highAmp=parseFloat(highAmpSlider.value);});
rotateSpeedSlider.addEventListener('input',()=>{autoRotateSpeed=parseFloat(rotateSpeedSlider.value);});
scatterSlider.addEventListener('input',()=>{scatteredFactor=parseFloat(scatterSlider.value);});

// -------------------- 左键旋转 & 滚轮缩放 --------------------
let rotating=false,lastX=0,lastY=0,currentScale=1;
window.addEventListener('mousedown',e=>{if(e.button!==0) return; rotating=true; lastX=e.clientX; lastY=e.clientY;});
window.addEventListener('mouseup',()=>{rotating=false;});
window.addEventListener('mousemove',e=>{
    if(rotating && points){
        points.rotation.y += (e.clientX-lastX)*0.01;
        points.rotation.x += (e.clientY-lastY)*0.01;
        lastX=e.clientX; lastY=e.clientY;
    }
});
window.addEventListener('wheel',e=>{
    e.preventDefault();
    if(!points) return;
    const f=1 - e.deltaY*0.0015;
    currentScale*=f;
    currentScale=Math.max(0.2,Math.min(5,currentScale));
    points.scale.set(currentScale,currentScale,currentScale);
},{passive:false});

// -------------------- 动画 --------------------
function animate(){
    requestAnimationFrame(animate);
    if(points){
        const posAttr=points.geometry.attributes.position;
        for(let i=0;i<basePositions.length;i++){
            const base=basePositions[i];
            const scatterVec=new THREE.Vector3((Math.random()-0.5)*600,(Math.random()-0.5)*600,(Math.random()-0.5)*600);
            const t=new THREE.Vector3().lerpVectors(base, scatterVec, scatteredFactor);
            if(analyser && audioElem && !audioElem.paused){
                analyser.getByteFrequencyData(dataArray);
                const low=dataArray[Math.floor(i*dataArray.length/basePositions.length*0.3)]||0;
                const mid=dataArray[Math.floor(i*dataArray.length/basePositions.length*0.3+dataArray.length*0.3)]||0;
                const high=dataArray[Math.floor(i*dataArray.length/basePositions.length*0.3+dataArray.length*0.6)]||0;
                t.z += (low/255*lowAmp + mid/255*midAmp + high/255*highAmp);
            }
            targetPositions[i].lerp(t,0.06);
            posAttr.array[i*3]=targetPositions[i].x;
            posAttr.array[i*3+1]=targetPositions[i].y;
            posAttr.array[i*3+2]=targetPositions[i].z;
        }
        posAttr.needsUpdate=true;
        points.rotation.y += autoRotateSpeed;
    }
    renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);});
</script>
</body>
</html>